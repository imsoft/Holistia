---
alwaysApply: true
---

# Cursor Rules para Holistia Platform

## Stack Tecnol√≥gico Principal
- Framework: Next.js 15.5.6 (App Router con Turbopack)
- React: 19.2.0
- TypeScript: 5 (strict mode habilitado)
- Base de datos: Supabase (PostgreSQL con RLS)
- Pagos: Stripe + Stripe Connect
- Estilos: Tailwind CSS 4
- Componentes UI: shadcn/ui + Radix UI
- Email: Resend API
- Mapas: Mapbox GL
- Formularios: React Hook Form + Zod
- Editor: Tiptap

## Estructura de Directorios

### Rutas y P√°ginas
- `/src/app/` - App Router de Next.js
  - `(auth)/` - P√°ginas de autenticaci√≥n
  - `(dashboard)/` - Dashboards por rol: `(admin)/`, `(professional)/`, `(patient)/`
  - `(website)/` - P√°ginas p√∫blicas
  - `api/` - API Routes (server-side)
- Las rutas din√°micas usan `[id]`, `[slug]`, etc.
- Los grupos de rutas usan par√©ntesis: `(dashboard)`, `(auth)`

### Componentes
- `/src/components/ui/` - Componentes reutilizables de UI (shadcn/ui)
- `/src/components/appointments/` - Componentes espec√≠ficos de citas
- `/src/components/reviews/` - Componentes de rese√±as
- `/src/components/shared/` - Componentes compartidos
- `/src/components/seo/` - Componentes SEO

### Utilidades y Helpers
- `/src/lib/` - Funciones helper y utilidades (ej: `lib/stripe.ts`, `lib/utils.ts`)
- `/src/utils/supabase/` - Clientes de Supabase (server/client)
- `/src/hooks/` - Custom React hooks
- `/src/actions/` - Server actions
- `/src/types/` - Definiciones de tipos TypeScript

### Base de Datos
- `/database/migrations/` - Migraciones SQL numeradas (ej: `01_`, `02_`, etc.)
- `/database/scripts/` - Scripts SQL de utilidad y verificaci√≥n

## Convenciones de C√≥digo

### TypeScript
- Usar TypeScript estricto siempre
- Evitar `any` - usar tipos espec√≠ficos o `unknown` cuando sea necesario
- Definir interfaces en `/src/types/` o inline si son muy espec√≠ficas
- Usar tipos union para estados: `'pending' | 'confirmed' | 'cancelled'`
- Campos opcionales con `?` o `| null` seg√∫n el caso

### Componentes React
- Usar `"use client"` solo cuando sea necesario (hooks, eventos, estado)
- Componentes del servidor por defecto (React Server Components)
- Nombres de componentes en PascalCase
- Props interfaces con sufijo `Props`: `interface ButtonProps { ... }`
- Usar `cn()` de `@/lib/utils` para clases condicionales de Tailwind

### Estilos
- Tailwind CSS 4 para todos los estilos
- Usar variables CSS de shadcn/ui para temas
- Componentes UI en `/src/components/ui/` deben seguir el patr√≥n de shadcn/ui
- Responsive: mobile-first con breakpoints de Tailwind

### Supabase y Base de Datos
- SIEMPRE usar RLS (Row Level Security) - nunca deshabilitar sin justificaci√≥n
- Verificar autenticaci√≥n con `supabase.auth.getUser()` antes de operaciones
- Usar tipos generados de Supabase cuando sea posible
- Las migraciones deben ser idempotentes: usar `IF NOT EXISTS`, `DROP IF EXISTS`
- Numerar migraciones secuencialmente: `107_`, `108_`, etc.
- Agregar comentarios SQL explicativos en migraciones complejas

### API Routes
- Ubicaci√≥n: `/src/app/api/`
- Siempre verificar autenticaci√≥n en API routes
- Validar input con Zod antes de procesar
- Usar `NextRequest` y `NextResponse` de Next.js
- Manejar errores adecuadamente con try/catch
- Retornar c√≥digos HTTP apropiados (200, 400, 401, 404, 500)

### Autenticaci√≥n y Seguridad
- Usar `createClient()` de `/utils/supabase/server` para server-side
- Usar `createClient()` de `/utils/supabase/client` para client-side
- NUNCA exponer `SUPABASE_SERVICE_ROLE_KEY` en el cliente
- Variables de entorno p√∫blicas deben empezar con `NEXT_PUBLIC_`
- Verificar permisos basados en `profiles.type` y `profiles.account_active`
- Middleware en `/src/middleware.ts` maneja redirecciones por tipo de usuario

### Stripe
- Funciones helper en `/src/lib/stripe.ts`
- Verificar que el profesional tenga `stripe_account_id` antes de crear transferencias
- Calcular comisiones: 15% para citas, 20% para eventos
- Manejar webhooks en `/src/app/api/stripe/webhook`
- Siempre verificar firmas de webhooks con `STRIPE_WEBHOOK_SECRET`

### Formularios
- Usar React Hook Form con Zod resolver
- Validaci√≥n tanto en cliente como en servidor
- Mostrar errores de validaci√≥n de forma clara al usuario
- Usar `toast` de `sonner` para feedback al usuario

### Manejo de Errores
- Usar `toast.error()` para errores del usuario
- `console.error()` para logging de desarrollo
- No exponer detalles de errores internos al usuario
- Manejar errores espec√≠ficos de Supabase (ej: PGRST116 para "no rows found")

### Im√°genes y Archivos
- Usar Next.js Image component para optimizaci√≥n
- Storage buckets en Supabase: `profiles`, `restaurants`, `holistic-centers`, `blog`
- Rutas de storage: `/<entity-id>/imagen.{ext}`
- Validar tipos de archivo y tama√±o antes de subir

### Variables de Entorno
- P√∫blicas (cliente): `NEXT_PUBLIC_*`
- Privadas (servidor): `SUPABASE_SERVICE_ROLE_KEY`, `STRIPE_SECRET_KEY`, `RESEND_API_KEY`
- Archivo `.env.local` NO se sube a git (est√° en .gitignore)

### Email
- Templates HTML en `/database/email-templates/`
- Usar Resend API (`resend` package)
- Funci√≥n helper: `sendEmail()` con templates
- Siempre incluir branding de Holistia en emails

## Patrones Espec√≠ficos del Proyecto

### Dashboards por Rol
- Rutas protegidas por middleware
- Layouts espec√≠ficos en `/app/(dashboard)/(admin|professional|patient)/`
- Cada dashboard tiene su propio sidebar y navegaci√≥n

### Citas (Appointments)
- Tabla: `appointments` con RLS habilitado
- Estados: `'pending' | 'confirmed' | 'completed' | 'cancelled'`
- Integraci√≥n con Stripe para pagos
- Notificaciones por email autom√°ticas

### Profesionales
- Tabla principal: `professional_applications`
- Campos de Stripe Connect: `stripe_account_id`, `stripe_account_status`
- Campos de disponibilidad: `working_days`, `working_start_time`, `working_end_time`
- Sistema de bloques de disponibilidad: `availability_blocks`

### Eventos
- Tabla: `events_workshops`
- Registros: `event_registrations`
- Integraci√≥n con Stripe para pagos de eventos
- Sistema de confirmaci√≥n con c√≥digos

### Rese√±as y Calificaciones
- Tabla: `reviews` para calificaciones de pacientes
- Tabla: `admin_ratings` para calificaciones de administradores (0-5 estrellas)
- Vista agregada: `professional_review_stats`
- Componente: `StarRating` para visualizaci√≥n

### Blog
- Tabla: `blog_posts`
- Storage bucket: `blog` para im√°genes
- Editor: Tiptap con extensions
- RLS para que solo admins puedan crear/editar

## Buenas Pr√°cticas

### Performance
- Usar React Server Components cuando sea posible
- Lazy loading de componentes pesados
- Optimizar im√°genes con Next.js Image
- Cach√© apropiado en Supabase queries cuando sea posible

### Accesibilidad
- Usar componentes de Radix UI (ya accesibles)
- Labels apropiados en formularios
- ARIA attributes cuando sea necesario
- Navegaci√≥n por teclado funcional

### Testing y Debugging
- Usar console.log con emojis para debugging: üîç, ‚úÖ, ‚ùå, ‚ö†Ô∏è
- Verificar errores en Supabase Dashboard
- Revisar logs de Vercel en producci√≥n
- Scripts de verificaci√≥n en `/database/scripts/`

### Git y Commits
- Commits descriptivos en espa√±ol
- Separar cambios l√≥gicos en commits diferentes
- No commitear `.env.local` o archivos sensibles

## Comandos √ötiles

```bash
# Desarrollo
pnpm dev

# Build
pnpm build

# Linting
pnpm lint

# Migraciones (ejecutar manualmente en Supabase Dashboard)
# Ver archivos en /database/migrations/
```

## Advertencias Importantes

‚ö†Ô∏è **NUNCA:**
- Deshabilitar RLS sin justificaci√≥n t√©cnica
- Exponer service role keys en el cliente
- Hacer commits de archivos `.env*`
- Usar `any` en TypeScript sin comentar por qu√©
- Crear migraciones que no sean idempotentes
- Eliminar migraciones existentes (solo agregar nuevas)

‚úÖ **SIEMPRE:**
- Verificar autenticaci√≥n antes de operaciones sensibles
- Validar input del usuario (cliente y servidor)
- Manejar errores apropiadamente
- Usar tipos TypeScript espec√≠ficos
- Seguir la estructura de directorios establecida
- Documentar c√≥digo complejo o no obvio
